#!/bin/bash
#===================================================================================
#
# FILE: subscriber.sh
#
# USAGE: sh subscriber.sh <JOB_FILE> <TIME_OUT> <LOGGING>
#
# DESCRIPTION: Triggers full sync on nodes parallely using ssh/openssl
#              <JOB_FILE> : .job file generated by running collector.sh
#       
#This will spawn the script  subscriberclient.sh per each node for ||ly.
#
# NOTES: Make sure to run the script from enviroment where NE IP are pingable
#        like MSCM server 
#
# AUTHOR: ZPALSRI(srihari.palivela@tcs.com)
# VERSION: 1.0
# CREATED: 15.03.2018 
#
#===================================================================================

if [[ $# -ne 5 ]];then
    echo "Invalid number of parameters"
echo "	USAGE: sh subscriber.sh <JOB_FILE> <TIME_OUT> <LOGGING> <NUM_MOS> <NUM_NODES>"
    exit
fi

JOB_FILE=$1
TIMEOUT=$2
LOGGING=$3
NUM_MOS=$4
NUM_NODES=$5
cnt=0

#----------------------------------------------------------------------
# Spawns action runner per NE by iterating over .job file
#----------------------------------------------------------------------

while read -r line 
do
    PARAMS=$(echo $line | cut -d" " -f 1,2,3)
    sh subscriberclient.sh $PARAMS $TIMEOUT $LOGGING $NUM_MOS & 
    cnt=$((cnt+1))
    if [[ $cnt -ge $NUM_NODES ]]; then
	break
    fi
done< $JOB_FILE

# Wait for all spawned process to complete
wait

